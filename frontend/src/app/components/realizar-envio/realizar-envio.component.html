<div class="realizar-envio-container">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="title-icon">ðŸ“¦</span>
        Realizar EnvÃ­o
      </h1>
      <p class="page-subtitle">Complete los datos para crear un nuevo envÃ­o</p>
    </div>
  </header>

  <!-- Contenido principal -->
  <main class="main-content">
    <!-- Mensajes de estado -->
    <div class="messages-container">
      <div class="alert alert-error" *ngIf="errorMessage">
        <i class="alert-icon fas fa-exclamation-triangle"></i>
        <div class="alert-content">
          <div class="alert-title">Error</div>
          <div class="alert-message">{{ errorMessage }}</div>
        </div>
        <button class="alert-close" (click)="errorMessage = ''">&times;</button>
      </div>

      <div class="alert alert-success" *ngIf="successMessage">
        <i class="alert-icon fas fa-check-circle"></i>
        <div class="alert-content">
          <div class="alert-title">Ã‰xito</div>
          <div class="alert-message">{{ successMessage }}</div>
        </div>
        <button class="alert-close" (click)="successMessage = ''">&times;</button>
      </div>
    </div>

    <!-- Formulario principal -->
    <form class="shipment-form" #shipmentFormRef="ngForm" (ngSubmit)="onSubmit()">
      
      <!-- SecciÃ³n: InformaciÃ³n del destinatario -->
      <section class="form-section">
        <div class="section-header">
          <div class="section-icon">ðŸ‘¤</div>
          <div class="section-content">
            <h3 class="section-title">InformaciÃ³n del Destinatario</h3>
            <p class="section-description">Datos de la persona que recibirÃ¡ el envÃ­o</p>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="receiverName" class="form-label">Nombre completo *</label>
            <input 
              type="text" 
              class="form-input" 
              id="receiverName"
              [(ngModel)]="shipmentForm.receiverName"
              name="receiverName"
              required
              placeholder="Nombre del destinatario">
          </div>

          <div class="form-group">
            <label for="receiverEmail" class="form-label">Correo electrÃ³nico *</label>
            <input 
              type="email" 
              class="form-input" 
              id="receiverEmail"
              [(ngModel)]="shipmentForm.receiverEmail"
              name="receiverEmail"
              required
              placeholder="correo@ejemplo.com">
          </div>

          <div class="form-group">
            <label for="receiverPhone" class="form-label">TelÃ©fono</label>
            <input 
              type="tel" 
              class="form-input" 
              id="receiverPhone"
              [(ngModel)]="shipmentForm.receiverPhone"
              name="receiverPhone"
              placeholder="1234-5678">
          </div>

          <div class="form-group">
            <label for="receiverReference" class="form-label">Referencia *</label>
            <select 
              class="form-select" 
              id="receiverReference"
              [(ngModel)]="shipmentForm.receiverReference"
              name="receiverReference"
              required>
              <option value="casa">Casa</option>
              <option value="trabajo">Trabajo</option>
              <option value="gimnasio">Gimnasio</option>
              <option value="escuela">Escuela</option>
            </select>
          </div>

          <div class="form-group">
            <label for="receiverDepartamento" class="form-label">Departamento *</label>
            <div class="search-container">
              <input 
                type="text" 
                class="form-input" 
                id="receiverDepartamento"
                [(ngModel)]="busquedaDepartamento"
                name="busquedaDepartamento"
                (input)="onBuscarDepartamento()"
                (focus)="onFocusDepartamento()"
                (blur)="onBlurDepartamento()"
                placeholder="Buscar departamento..."
                required>
              
              <!-- Lista de departamentos filtrados -->
              <div class="search-results" *ngIf="mostrarListaDepartamentos && departamentosFiltrados.length > 0">
                <div 
                  class="search-item" 
                  *ngFor="let departamento of departamentosFiltrados"
                  (click)="seleccionarDepartamento(departamento)">
                  <i class="fas fa-map-marker-alt search-item-icon"></i>
                  <span>{{ departamento }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="receiverMunicipio" class="form-label">Municipio *</label>
            <div class="search-container">
              <input 
                type="text" 
                class="form-input" 
                id="receiverMunicipio"
                [(ngModel)]="busquedaMunicipio"
                name="busquedaMunicipio"
                (input)="onBuscarMunicipio()"
                (focus)="onFocusMunicipio()"
                (blur)="onBlurMunicipio()"
                placeholder="Buscar municipio..."
                required>
              
              <!-- Lista de municipios filtrados -->
              <div class="search-results" *ngIf="mostrarListaMunicipios && municipiosFiltrados.length > 0">
                <div 
                  class="search-item" 
                  *ngFor="let municipio of municipiosFiltrados"
                  (click)="seleccionarMunicipio(municipio)">
                  <i class="fas fa-city search-item-icon"></i>
                  <div class="search-item-content">
                    <div class="search-item-name">{{ municipio.nombre }}</div>
                    <div class="search-item-dept">{{ municipio.departamento }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group span-2">
            <label for="receiverPoblado" class="form-label">Zona/Poblado</label>
            <input 
              type="text" 
              class="form-input" 
              id="receiverPoblado"
              [(ngModel)]="shipmentForm.receiverPoblado"
              name="receiverPoblado"
              placeholder="Zona o poblado">
          </div>
        </div>
      </section>

      <!-- SecciÃ³n: MÃ©todo de pago -->
      <section class="form-section">
        <div class="section-header">
          <div class="section-icon">ðŸ’³</div>
          <div class="section-content">
            <h3 class="section-title">MÃ©todo de Pago</h3>
            <p class="section-description">Seleccione cÃ³mo desea pagar el envÃ­o</p>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group span-2">
            <label for="paymentMethodId" class="form-label">MÃ©todo de pago *</label>
            <select 
              class="form-select" 
              id="paymentMethodId"
              [(ngModel)]="shipmentForm.paymentMethodId"
              name="paymentMethodId"
              (change)="onMetodoPagoChange()"
              required>
              <option value="">Seleccionar mÃ©todo...</option>
              <option *ngFor="let method of paymentMethods" [value]="method._id">
                {{ method.displayName }} 
                <span *ngIf="method.fees.fixedAmount > 0">(+Q{{ method.fees.fixedAmount }})</span>
              </option>
            </select>
          </div>
        </div>
      </section>

      <!-- SecciÃ³n: InformaciÃ³n del paquete -->
      <section class="form-section">
        <div class="section-header">
          <div class="section-icon">ðŸ“¦</div>
          <div class="section-content">
            <h3 class="section-title">Â¿QuÃ© tipo de paquete desea enviar?</h3>
            <p class="section-description">Seleccione el tipo de paquete que mejor se adapte a su envÃ­o</p>
          </div>
        </div>

        <!-- Selector de tipos de paquete visual -->
        <div class="tipos-paquete-grid">
          <div 
            *ngFor="let tipo of tiposPaqueteVisualizacion" 
            class="tipo-paquete-card"
            [class.selected]="tipoSeleccionado?.id === tipo.id"
            (click)="seleccionarTipoPaquete(tipo)"
            [style.background]="tipo.color"
          >
            <div class="paquete-icono">{{ tipo.icono }}</div>
            <h3 class="paquete-nombre">{{ tipo.nombre }}</h3>
            <div class="paquete-limites">
              <div class="limite-item">
                <span class="limite-label">MÃ¡x:</span>
                <span class="limite-valor">{{ tipo.limiteSize }}</span>
              </div>
              <div class="limite-item">
                <span class="limite-label">Peso:</span>
                <span class="limite-valor">{{ tipo.limitePeso }}</span>
              </div>
            </div>
            <p class="paquete-descripcion">{{ tipo.descripcion }}</p>
            <div class="selection-indicator" *ngIf="tipoSeleccionado?.id === tipo.id">
              âœ“ Seleccionado
            </div>
          </div>
        </div>

        <!-- Campos adicionales del paquete -->
        <div class="form-grid" style="margin-top: 2rem;">
          <div class="form-group">
            <label for="packageWeight" class="form-label">Peso (kg)</label>
            <input 
              type="number" 
              class="form-input" 
              id="packageWeight"
              [(ngModel)]="shipmentForm.packageWeight"
              name="packageWeight"
              min="0.1"
              step="0.1"
              placeholder="0.0">
          </div>

          <div class="form-group">
            <label for="packageValue" class="form-label">Valor declarado (Q)</label>
            <input 
              type="number" 
              class="form-input" 
              id="packageValue"
              [(ngModel)]="shipmentForm.packageValue"
              name="packageValue"
              min="1"
              placeholder="100.00">
          </div>

          <div class="form-group span-2">
            <label for="packageDescription" class="form-label">DescripciÃ³n del contenido</label>
            <input 
              type="text" 
              class="form-input" 
              id="packageDescription"
              [(ngModel)]="shipmentForm.packageDescription"
              name="packageDescription"
              placeholder="DescripciÃ³n detallada del contenido">
          </div>
        </div>
      </section>

      <!-- SecciÃ³n: Resumen -->
      <section class="form-section summary-section" *ngIf="costoTotal > 0">
        <div class="section-header">
          <div class="section-icon">ðŸ§®</div>
          <div class="section-content">
            <h3 class="section-title">Resumen del EnvÃ­o</h3>
            <p class="section-description">Detalles y costo total</p>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-item">
            <span class="summary-label">Costo Total:</span>
            <span class="summary-value">Q{{ costoTotal.toFixed(2) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Codigo de Guia:</span>
            <span class="summary-value">{{ codigoGuia || 'Se generara al crear' }}</span>
          </div>
        </div>
      </section>

      <!-- Botones de accion -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="resetForm()">
          <span class="btn-icon">ðŸ”„</span>
          Limpiar
        </button>
        
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="isSubmitting || !shipmentFormRef.form.valid">
          <span class="btn-icon" *ngIf="!isSubmitting">ðŸš€</span>
          <span class="btn-icon spinner" *ngIf="isSubmitting">âŸ²</span>
          {{ isSubmitting ? 'Creando Envio...' : 'Crear Envio' }}
        </button>
      </div>

    </form>
  </main>
</div>