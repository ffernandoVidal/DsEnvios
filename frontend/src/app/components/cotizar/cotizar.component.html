<div class="page-container">
  <div class="cotizar-header">
    <h1>Cotizar Env√≠o</h1>
    <p class="subtitle">Obt√©n una cotizaci√≥n personalizada para tu env√≠o en Guatemala</p>
  </div>

  <div class="cotizar-form">
    <div class="form-row">
      <!-- ORIGEN -->
      <div class="form-group">
        <h2 class="form-title">¬øDesde d√≥nde se env√≠a el paquete?</h2>
        <p class="form-subtitle">Poblado, municipio o departamento</p>
        
        <div class="search-container">
          <div class="input-wrapper">
            <input 
              type="text" 
              class="search-input"
              placeholder="Buscar o seleccionar ciudad, municipio o departamento..."
              [value]="busquedaOrigen"
              (input)="filtrarOrigen($event)"
              (focus)="mostrarListaCompleta('origen')"
              (blur)="ocultarLista('origen')"
            >
            <button *ngIf="origenSeleccionado" class="clear-btn" (click)="limpiarOrigen()">‚úï</button>
            <button class="list-btn" (click)="mostrarListaCompleta('origen')">üìã</button>
          </div>
          
          <div class="dropdown" *ngIf="mostrarListaOrigen || (origenFiltrado.length > 0 && busquedaOrigen !== origenSeleccionado)">
            <div class="dropdown-header">
              <span>üìç Selecciona el origen</span>
              <input 
                type="text" 
                class="dropdown-search"
                placeholder="Buscar en la lista..."
                [value]="busquedaOrigen"
                (input)="filtrarOrigen($event)"
                (click)="$event.stopPropagation()"
              >
            </div>
            <ul class="dropdown-list">
              <li 
                *ngFor="let ubicacion of origenFiltrado.slice(0, 50)" 
                class="dropdown-item"
                (click)="seleccionarOrigen(ubicacion)"
              >
                <span class="municipio">{{ ubicacion.split(',')[0] }}</span>
                <span class="departamento">{{ ubicacion.split(',')[1] }}</span>
              </li>
            </ul>
            <div class="dropdown-footer" *ngIf="origenFiltrado.length > 50">
              <span>Mostrando 50 de {{origenFiltrado.length}} resultados. Usa la b√∫squeda para encontrar m√°s espec√≠ficamente.</span>
            </div>
            <div class="dropdown-footer" *ngIf="origenFiltrado.length === 0 && busquedaOrigen">
              <span>No se encontraron resultados para "{{busquedaOrigen}}"</span>
            </div>
          </div>
        </div>

        <div class="selected-location" *ngIf="origenSeleccionado">
          <span class="location-icon">üìç</span>
          <span class="location-text">{{ origenSeleccionado }}</span>
          <button class="change-btn" (click)="limpiarOrigen()">Cambiar</button>
        </div>
      </div>

      <!-- DESTINO -->
      <div class="form-group">
        <h2 class="form-title">¬øA d√≥nde se env√≠a el paquete?</h2>
        <p class="form-subtitle">Poblado, municipio o departamento</p>
        
        <div class="search-container">
          <div class="input-wrapper">
            <input 
              type="text" 
              class="search-input"
              placeholder="Buscar o seleccionar ciudad, municipio o departamento..."
              [value]="busquedaDestino"
              (input)="filtrarDestino($event)"
              (focus)="mostrarListaCompleta('destino')"
              (blur)="ocultarLista('destino')"
            >
            <button *ngIf="destinoSeleccionado" class="clear-btn" (click)="limpiarDestino()">‚úï</button>
            <button class="list-btn" (click)="mostrarListaCompleta('destino')">üìã</button>
          </div>
          
          <div class="dropdown" *ngIf="mostrarListaDestino || (destinoFiltrado.length > 0 && busquedaDestino !== destinoSeleccionado)">
            <div class="dropdown-header">
              <span>üéØ Selecciona el destino</span>
              <input 
                type="text" 
                class="dropdown-search"
                placeholder="Buscar en la lista..."
                [value]="busquedaDestino"
                (input)="filtrarDestino($event)"
                (click)="$event.stopPropagation()"
              >
            </div>
            <ul class="dropdown-list">
              <li 
                *ngFor="let ubicacion of destinoFiltrado.slice(0, 50)" 
                class="dropdown-item"
                (click)="seleccionarDestino(ubicacion)"
              >
                <span class="municipio">{{ ubicacion.split(',')[0] }}</span>
                <span class="departamento">{{ ubicacion.split(',')[1] }}</span>
              </li>
            </ul>
            <div class="dropdown-footer" *ngIf="destinoFiltrado.length > 50">
              <span>Mostrando 50 de {{destinoFiltrado.length}} resultados. Usa la b√∫squeda para encontrar m√°s espec√≠ficamente.</span>
            </div>
            <div class="dropdown-footer" *ngIf="destinoFiltrado.length === 0 && busquedaDestino">
              <span>No se encontraron resultados para "{{busquedaDestino}}"</span>
            </div>
          </div>
        </div>

        <div class="selected-location" *ngIf="destinoSeleccionado">
          <span class="location-icon">üéØ</span>
          <span class="location-text">{{ destinoSeleccionado }}</span>
          <button class="change-btn" (click)="limpiarDestino()">Cambiar</button>
        </div>
      </div>
    </div>

    <!-- SECCI√ìN DE PAQUETES -->
    <div class="paquetes-section">
      <div class="paquetes-header">
        <h2 class="form-title">¬øQu√© tipo de paquete desea enviar?</h2>
        <button 
          class="agregar-paquete-btn"
          [class.disabled]="!tipoSeleccionado"
          [disabled]="!tipoSeleccionado"
          (click)="agregarPaquete()"
        >
          <span class="btn-icon">‚ûï</span>
          Agregar Paquete
        </button>
      </div>

      <!-- SELECTOR DE TIPOS DE PAQUETE -->
      <div class="tipos-paquete-grid">
        <div 
          *ngFor="let tipo of tiposPaquete" 
          class="tipo-paquete-card"
          [class.selected]="tipoSeleccionado?.id === tipo.id"
          (click)="seleccionarTipoPaquete(tipo)"
          [style.background]="tipo.color"
        >
          <div class="paquete-icono">{{ tipo.icono }}</div>
          <h3 class="paquete-nombre">{{ tipo.nombre }}</h3>
          <div class="paquete-limites">
            <div class="limite-item">
              <span class="limite-label">M√°x:</span>
              <span class="limite-valor">{{ tipo.limiteSize }}</span>
            </div>
            <div class="limite-item">
              <span class="limite-label">Peso:</span>
              <span class="limite-valor">{{ tipo.limitePeso }}</span>
            </div>
          </div>
          <p class="paquete-descripcion">{{ tipo.descripcion }}</p>
          <div class="selection-indicator" *ngIf="tipoSeleccionado?.id === tipo.id">
            ‚úì Seleccionado
          </div>
        </div>
      </div>

      <!-- PAQUETES AGREGADOS -->
      <div class="paquetes-agregados" *ngIf="paquetesSeleccionados.length > 0">
        <h3 class="agregados-titulo">üì¶ Paquetes Agregados ({{ paquetesSeleccionados.length }})</h3>
        <div class="paquetes-lista">
          <div 
            *ngFor="let paquete of paquetesSeleccionados" 
            class="paquete-agregado"
            [style.border-left-color]="paquete.tipo.color"
          >
            <div class="paquete-info">
              <div class="paquete-header-info">
                <span class="paquete-icono-small">{{ paquete.tipo.icono }}</span>
                <input 
                  type="text" 
                  class="nombre-input"
                  [value]="paquete.nombrePersonalizado"
                  (input)="actualizarNombre(paquete.id, $any($event.target).value)"
                  placeholder="Nombre del paquete"
                >
              </div>
              <div class="paquete-detalles">
                <span class="detalle-tipo">{{ paquete.tipo.nombre }}</span>
                <span class="detalle-limites">{{ paquete.tipo.limiteSize }} | {{ paquete.tipo.limitePeso }}</span>
              </div>
            </div>
            <div class="paquete-controles">
              <div class="cantidad-control">
                <label>Cantidad:</label>
                <input 
                  type="number" 
                  min="1" 
                  max="99"
                  class="cantidad-input"
                  [value]="paquete.cantidad"
                  (input)="actualizarCantidad(paquete.id, +$any($event.target).value)"
                >
              </div>
              <button 
                class="eliminar-btn"
                (click)="eliminarPaquete(paquete.id)"
                title="Eliminar paquete"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOT√ìN DE COTIZACI√ìN -->
    <div class="cotizar-actions">
      <button 
        class="cotizar-btn"
        [class.disabled]="!origenSeleccionado || !destinoSeleccionado || paquetesSeleccionados.length === 0 || cotizacionEnProceso"
        [disabled]="!origenSeleccionado || !destinoSeleccionado || paquetesSeleccionados.length === 0 || cotizacionEnProceso"
        (click)="cotizarEnvio()"
      >
        <span class="btn-icon" *ngIf="!cotizacionEnProceso">üí∞</span>
        <span class="btn-icon spinner" *ngIf="cotizacionEnProceso">‚è≥</span>
        <span *ngIf="!cotizacionEnProceso">Cotizar Env√≠o</span>
        <span *ngIf="cotizacionEnProceso">Calculando...</span>
        <span class="paquetes-count" *ngIf="paquetesSeleccionados.length > 0 && !cotizacionEnProceso">
          ({{ paquetesSeleccionados.length }} {{ paquetesSeleccionados.length === 1 ? 'paquete' : 'paquetes' }})
        </span>
      </button>
    </div>

    <!-- RESULTADOS DE COTIZACI√ìN -->
    <div id="cotizacion-resultado" class="cotizacion-resultado" *ngIf="cotizacionResultado || mensajeError">
      
      <!-- Error -->
      <div class="error-message" *ngIf="mensajeError">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-content">
          <h3>Error en la cotizaci√≥n</h3>
          <p>{{ mensajeError }}</p>
          <button class="retry-btn" (click)="cotizarEnvio()" *ngIf="origenSeleccionado && destinoSeleccionado && paquetesSeleccionados.length > 0">
            Intentar nuevamente
          </button>
        </div>
      </div>

      <!-- Cotizaci√≥n exitosa -->
      <div class="cotizacion-exitosa" *ngIf="cotizacionResultado && cotizacionResultado.success">
        
        <!-- Header del resultado -->
        <div class="resultado-header">
          <div class="resultado-icon">‚úÖ</div>
          <div class="resultado-title">
            <h3>¬°Cotizaci√≥n Generada!</h3>
            <p class="resultado-subtitle">{{ cotizacionResultado.message }}</p>
          </div>
          <button class="close-btn" (click)="limpiarCotizacion()">‚úï</button>
        </div>

        <!-- Informaci√≥n de ruta -->
        <div class="ruta-info">
          <div class="ubicacion origen">
            <span class="ubicacion-icon">üìç</span>
            <div class="ubicacion-text">
              <strong>Origen:</strong><br>
              {{ cotizacionResultado.cotizacion.origen.display }}
            </div>
          </div>
          
          <div class="distancia-info">
            <div class="distancia-linea"></div>
            <div class="distancia-datos">
              <span class="distancia-valor">{{ cotizacionResultado.cotizacion.distancia.distanceText }}</span>
              <span class="tiempo-valor">{{ cotizacionResultado.cotizacion.distancia.durationText }}</span>
            </div>
          </div>

          <div class="ubicacion destino">
            <span class="ubicacion-icon">üéØ</span>
            <div class="ubicacion-text">
              <strong>Destino:</strong><br>
              {{ cotizacionResultado.cotizacion.destino.display }}
            </div>
          </div>
        </div>

        <!-- Selector de servicio -->
        <div class="servicio-selector" *ngIf="cotizacionResultado.cotizacion.servicios.length > 1">
          <h4>Tipo de servicio:</h4>
          <div class="servicios-opciones">
            <button 
              *ngFor="let servicio of cotizacionResultado.cotizacion.servicios"
              class="servicio-opcion"
              [class.selected]="servicioSeleccionado === servicio.id"
              (click)="cambiarServicio(servicio.id)"
            >
              <div class="servicio-nombre">{{ servicio.nombre }}</div>
              <div class="servicio-tiempo">{{ servicio.tiempo_entrega }}</div>
              <div class="servicio-precio">Desde {{ formatearPrecio(servicio.precio_base) }}</div>
            </button>
          </div>
        </div>

        <!-- Detalles de paquetes -->
        <div class="paquetes-detalle">
          <h4>Detalles de env√≠o:</h4>
          <div class="paquete-item" *ngFor="let paquete of cotizacionResultado.cotizacion.paquetes">
            <div class="paquete-info">
              <div class="paquete-nombre">
                <strong>{{ paquete.nombre }}</strong>
                <span class="paquete-cantidad" *ngIf="paquete.cantidad > 1">x{{ paquete.cantidad }}</span>
              </div>
              <div class="paquete-servicio">{{ getNombreServicio(paquete.serviceType) }}</div>
            </div>
            <div class="paquete-precio">
              <div class="precio-individual">{{ formatearPrecio(paquete.total) }}</div>
              <div class="precio-total" *ngIf="paquete.cantidad > 1">
                Total: {{ formatearPrecio(paquete.total * paquete.cantidad) }}
              </div>
            </div>
          </div>
        </div>

        <!-- Desglose de precios -->
        <div class="precio-desglose" *ngIf="cotizacionResultado.cotizacion.paquetes[0]?.breakdown">
          <h4>Desglose de costos:</h4>
          <div class="desglose-item" *ngFor="let item of getDesgloseItems(cotizacionResultado.cotizacion.paquetes[0].breakdown)">
            <span class="desglose-concepto">{{ item.concepto }}</span>
            <span class="desglose-valor">{{ formatearPrecio(item.valor) }}</span>
          </div>
        </div>

        <!-- Total general -->
        <div class="total-general">
          <div class="total-label">Total General:</div>
          <div class="total-valor">{{ formatearPrecio(cotizacionResultado.cotizacion.total_general) }} {{ cotizacionResultado.cotizacion.moneda }}</div>
        </div>

        <!-- Informaci√≥n adicional -->
        <div class="info-adicional">
          <div class="info-item">
            <span class="info-icon">‚è∞</span>
            <span>Tiempo estimado: {{ cotizacionResultado.cotizacion.tiempo_entrega }}</span>
          </div>
          <div class="info-item">
            <span class="info-icon">üìÖ</span>
            <span>Cotizaci√≥n v√°lida hasta: {{ formatearFecha(cotizacionResultado.cotizacion.valida_hasta) }}</span>
          </div>
        </div>

        <!-- Acciones -->
        <div class="resultado-acciones">
          <button class="btn-proceder" (click)="procederConEnvio()">
            <span class="btn-icon">üì¶</span>
            Proceder con este env√≠o
          </button>
          <button class="btn-nueva-cotizacion" (click)="nuevaCotizacion()">
            <span class="btn-icon">üîÑ</span>
            Nueva cotizaci√≥n
          </button>
        </div>

      </div>
    </div>

    <!-- INFORMACI√ìN ADICIONAL -->
    <div class="info-section">
      <div class="info-card">
        <h3>üì¶ Informaci√≥n del Servicio</h3>
        <ul>
          <li>‚úÖ Cobertura en los 22 departamentos de Guatemala</li>
          <li>‚úÖ M√°s de 300 municipios disponibles</li>
          <li>‚úÖ Cotizaci√≥n gratuita e inmediata</li>
          <li>‚úÖ Diferentes opciones de env√≠o</li>
        </ul>
      </div>
    </div>
  </div>
</div>


